!function(t,i,e){var a=(e.un,e.uns,e["static"]),r=e["class"],n=e.getset,s=(e.__newvec,laya.webgl.shader.Shader),o=laya.utils.Handler,l=laya.renders.Render,h=(laya.renders.RenderSprite,laya.webgl.utils.IndexBuffer),c=laya.display.Sprite,u=(laya.renders.RenderContext,laya.maths.MathUtil),d=laya.utils.Stat,_=(laya.events.Event,laya.net.Loader,laya.resource.Texture),m=laya.maths.Matrix,f=laya.utils.Timer,p=laya.webgl.canvas.BlendMode,v=laya.webgl.WebGL,y=(laya.webgl.WebGLContext,laya.utils.Utils),x=(laya.display.Stage,laya.webgl.utils.VertexBuffer),P=laya.utils.Browser,g=laya.webgl.shader.d2.value.Value2D,C=function(){function t(){this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60,this._particleTemplate=null}r(t,"laya.particle.emitter.EmitterBase");var i=t.prototype;return i.start=function(t){void 0===t&&(t=Number.MAX_VALUE),0!=this._emissionRate&&(this._emissionTime=t)},i.stop=function(){this._emissionTime=0},i.clear=function(){this._emissionTime=0},i.emit=function(){},i.advanceTime=function(t){if(void 0===t&&(t=1),this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()},n(0,i,"particleTemplate",null,function(t){this._particleTemplate=t}),n(0,i,"emissionRate",function(){return this._emissionRate},function(t){0>=t||(this._emissionRate=t,t>0&&(this.minEmissionTime=1/t))}),t}(),R=function(){function t(){this.position=null,this.velocity=null,this.color=null,this.sizeRotation=null,this.radiusRadian=null,this.durationAddScale=NaN,this.time=NaN}return r(t,"laya.particle.ParticleData"),t.Create=function(i,e,a,r){var n=new t;n.position=e,u.scaleVector3(a,i.emitterVelocitySensitivity,t._tempVelocity);var s=u.lerp(i.minHorizontalVelocity,i.maxHorizontalVelocity,Math.random()),o=Math.random()*Math.PI*2;t._tempVelocity[0]+=s*Math.cos(o),t._tempVelocity[2]+=s*Math.sin(o),t._tempVelocity[1]+=u.lerp(i.minVerticalVelocity,i.maxVerticalVelocity,Math.random()),n.velocity=t._tempVelocity,n.color=t._tempColor;var l=0;if(i.colorComponentInter)for(l=0;4>l;l++)n.color[l]=u.lerp(i.minColor[l],i.maxColor[l],Math.random());else u.lerpVector4(i.minColor,i.maxColor,Math.random(),n.color);n.sizeRotation=t._tempSizeRotation;var h=Math.random();n.sizeRotation[0]=u.lerp(i.minStartSize,i.maxStartSize,h),n.sizeRotation[1]=u.lerp(i.minEndSize,i.maxEndSize,h),n.sizeRotation[2]=u.lerp(i.minRotateSpeed,i.maxRotateSpeed,Math.random()),n.radiusRadian=t._tempRadiusRadian;var c=Math.random();return n.radiusRadian[0]=u.lerp(i.minStartRadius,i.maxStartRadius,c),n.radiusRadian[1]=u.lerp(i.minEndRadius,i.maxEndRadius,c),n.radiusRadian[2]=u.lerp(i.minHorizontalEndRadian,i.maxHorizontalEndRadian,Math.random()),n.radiusRadian[3]=u.lerp(i.minVerticalEndRadian,i.maxVerticalEndRadian,Math.random()),n.durationAddScale=i.ageAddScale*Math.random(),n.time=r,n},a(t,["_tempVelocity",function(){return this._tempVelocity=new Float32Array(3)},"_tempColor",function(){return this._tempColor=new Float32Array(4)},"_tempSizeRotation",function(){return this._tempSizeRotation=new Float32Array(3)},"_tempRadiusRadian",function(){return this._tempRadiusRadian=new Float32Array(4)}]),t}(),V=(function(){function t(t,i,e){this._templet=null,this._timeBetweenParticles=NaN,this._previousPosition=null,this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=t,this._timeBetweenParticles=1/i,this._previousPosition=e}r(t,"laya.particle.ParticleEmitter");var i=t.prototype;return i.update=function(t,i){if(t/=1e3,t>0){u.subtractVector3(i,this._previousPosition,this._tempVelocity),u.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var e=this._timeLeftOver+t,a=-this._timeLeftOver;e>this._timeBetweenParticles;)a+=this._timeBetweenParticles,e-=this._timeBetweenParticles,u.lerpVector3(this._previousPosition,i,a/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=e}this._previousPosition[0]=i[0],this._previousPosition[1]=i[1],this._previousPosition[2]=i[2]},t}(),function(){function t(){this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.colorComponentInter=!1,this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.emitterVelocitySensitivity=1,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.gravity=new Float32Array([0,0,0]),this.minColor=new Float32Array([1,1,1,1]),this.maxColor=new Float32Array([1,1,1,1]),this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.positionVariance=new Float32Array([0,0,0])}return r(t,"laya.particle.ParticleSettings"),t}(),function(){function t(){this.settings=null,this.texture=null}r(t,"laya.particle.ParticleTemplateBase");var i=t.prototype;return i.addParticleArray=function(t,i){},t}()),A=function(){function t(){this.u_EndVelocity=NaN,this.u_Gravity=null,this.u_Duration=NaN,this.a_RadiusRadian=null,this.a_Position=null,this.a_SizeRotation=null,this.a_Color=null,this.a_Velocity=null,this.gl_Position=null,this.v_Color=null,this.a_AgeAddScale=NaN,this.oSize=NaN,this._color=new Float32Array(4),this._position=new Float32Array(3)}r(t,"laya.particle.particleUtils.CanvasShader");var i=t.prototype;return i.getLen=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},i.ComputeParticlePosition=function(t,i,e,a){this._position[0]=t[0],this._position[1]=t[1],this._position[2]=t[2];var r=this.getLen(i),n=r*this.u_EndVelocity,s=r*a+(n-r)*a*a/2,o=NaN;o=this.getLen(i);var l=0,h=0;for(h=3,l=0;h>l;l++)this._position[l]+=this._position[l]+i[l]/o*s*this.u_Duration,this._position[l]+=this.u_Gravity[l]*e*a;var c=u.lerp(this.a_RadiusRadian[0],this.a_RadiusRadian[1],a),d=this.a_RadiusRadian[2]*a,_=this.a_RadiusRadian[3]*a,m=Math.cos(_)*c;return this._position[1]+=Math.sin(_)*c,this._position[0]+=Math.cos(d)*m,this._position[2]+=Math.sin(d)*m,new Float32Array([this._position[0],this._position[1],0,1])},i.ComputeParticleSize=function(t,i,e){var a=u.lerp(t,i,e);return a},i.ComputeParticleRotation=function(t,i){return t*i},i.ComputeParticleColor=function(t,i,e){var a=this._color;return a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[3]*e*(1-e)*(1-e)*6.7,a},i.clamp=function(t,i,e){return i>t?i:t>e?e:t},i.getData=function(t){t*=1+this.a_AgeAddScale;var i=this.clamp(t/this.u_Duration,0,1);this.gl_Position=this.ComputeParticlePosition(this.a_Position,this.a_Velocity,t,i);var e=this.ComputeParticleSize(this.a_SizeRotation[0],this.a_SizeRotation[1],i),a=this.ComputeParticleRotation(this.a_SizeRotation[2],t);this.v_Color=this.ComputeParticleColor(this.gl_Position,this.a_Color,i);var r=new m,n=NaN;n=e/this.oSize*2,r.scale(n,n),r.rotate(a),r.setTranslate(this.gl_Position[0],-this.gl_Position[1]);var s=NaN;return s=this.v_Color[3],[this.v_Color,s,r,this.v_Color[0]*s,this.v_Color[1]*s,this.v_Color[2]*s]},t}(),E=function(){function t(){this.maxIndex=0,this.cmds=null,this.id=0}r(t,"laya.particle.particleUtils.CMDParticle");var i=t.prototype;return i.setCmds=function(t){this.cmds=t,this.maxIndex=t.length-1},t}(),T=function(){function t(){}return r(t,"laya.particle.particleUtils.PicTool"),t.getCanvasPic=function(t,i){t=t.bitmap;var e=P.createElement("canvas"),a=e.getContext("2d");e.height=t.height,e.width=t.width,a.drawImage(t.source,0,0);for(var r=a.getImageData(0,0,e.width,e.height),n=r.data,s=i>>16&255,o=i>>8&255,l=255&i,h=0,c=n.length;c>h;h+=4)0!=n[h+3]&&(n[h]=s,n[h+1]=o,n[h+2]=l);return a.putImageData(r,0,0),e.source=e,e},t.getRGBPic=function(i){var e;return e=[new _(t.getCanvasPic(i,16711680)),new _(t.getCanvasPic(i,65280)),new _(t.getCanvasPic(i,255))]},t}(),w=(function(){function t(){v.enable(),e.init(200,200)}return r(t,"laya.particle.TestParticle"),t}(),function(t){function i(t){this.settiong=null,this._posRange=null,this._canvasTemplate=null,this._emitFun=null,i.__super.call(this),this._particleTemplate=t,this.settiong=t.settings,this._posRange=this.settiong.positionVariance,t instanceof laya.particle.ParticleTemplate2D?this._emitFun=this.webGLEmit:t instanceof laya.particle.ParticleTemplateCanvas&&(this._canvasTemplate=t,this._emitFun=this.canvasEmit)}r(i,"laya.particle.emitter.Emitter2D",t);var e=i.prototype;return e.emit=function(){t.prototype.emit.call(this),null!=this._emitFun&&this._emitFun()},e.getRandom=function(t){return(2*Math.random()-1)*t},e.webGLEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=0,this._particleTemplate.addParticleArray(t,i)},e.canvasEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=0,this._particleTemplate.addParticleArray(t,i)},i}(C)),S=function(t){function i(t){this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._floatCountPerVertex=23,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,i.__super.call(this),this.settings=t}r(i,"laya.particle.ParticleTemplateWebGL",t);var e=i.prototype;return e.initialize=function(){this._vertices=new Float32Array(this.settings.maxPartices*this._floatCountPerVertex*4);for(var t=0,i=0;i<this.settings.maxPartices;i++){var e=Math.random(),a=this.settings.textureCount?1/this.settings.textureCount:1,r=NaN;for(r=0;r<this.settings.textureCount&&!(r+a>e);r+=a);t=i*this._floatCountPerVertex*4,this._vertices[t+0*this._floatCountPerVertex+0]=-1,this._vertices[t+0*this._floatCountPerVertex+1]=-1,this._vertices[t+0*this._floatCountPerVertex+2]=0,this._vertices[t+0*this._floatCountPerVertex+3]=r,this._vertices[t+1*this._floatCountPerVertex+0]=1,this._vertices[t+1*this._floatCountPerVertex+1]=-1,this._vertices[t+1*this._floatCountPerVertex+2]=1,this._vertices[t+1*this._floatCountPerVertex+3]=r,this._vertices[t+2*this._floatCountPerVertex+0]=1,this._vertices[t+2*this._floatCountPerVertex+1]=1,this._vertices[t+2*this._floatCountPerVertex+2]=1,this._vertices[t+2*this._floatCountPerVertex+3]=r+a,this._vertices[t+3*this._floatCountPerVertex+0]=-1,this._vertices[t+3*this._floatCountPerVertex+1]=1,this._vertices[t+3*this._floatCountPerVertex+2]=0,this._vertices[t+3*this._floatCountPerVertex+3]=r+a}},e.loadContent=function(){this._vertexBuffer=x.create(35048);for(var t=new Uint16Array(6*this.settings.maxPartices),i=0;i<this.settings.maxPartices;i++)t[6*i+0]=4*i+0,t[6*i+1]=4*i+1,t[6*i+2]=4*i+2,t[6*i+3]=4*i+0,t[6*i+4]=4*i+2,t[6*i+5]=4*i+3;this._indexBuffer=h.create(),this._indexBuffer.clear(),this._indexBuffer.append(t),this._indexBuffer.upload()},e.update=function(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)},e.retireActiveParticles=function(){for(var t=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var i=this._firstActiveElement*this._floatCountPerVertex*4+22,e=this._currentTime-this._vertices[i];if(t>e)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}},e.freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+22];if(3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}},e.addNewParticlesToVertexBuffer=function(){this._vertexBuffer.clear(),this._vertexBuffer.append(this._vertices);var t=0;this._firstNewElement<this._firstFreeElement?(t=4*this._firstNewElement*this._floatCountPerVertex*4,this._vertexBuffer.subUpload(t,t,t+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(t=4*this._firstNewElement*this._floatCountPerVertex*4,this._vertexBuffer.subUpload(t,t,t+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(this._vertexBuffer.setNeedUpload(),this._vertexBuffer.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement},e.addParticleArray=function(t,i){var e=this._firstFreeElement+1;if(e>=this.settings.maxPartices&&(e=0),e!==this._firstRetiredElement){for(var a=R.Create(this.settings,t,i,this._currentTime),r=this._firstFreeElement*this._floatCountPerVertex*4,n=0;4>n;n++){var s=0,o=0;for(s=0,o=4;3>s;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.position[s];for(s=0,o=7;3>s;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.velocity[s];for(s=0,o=10;4>s;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.color[s];for(s=0,o=14;3>s;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.sizeRotation[s];for(s=0,o=17;4>s;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.radiusRadian[s];this._vertices[r+n*this._floatCountPerVertex+21]=a.durationAddScale,this._vertices[r+n*this._floatCountPerVertex+22]=a.time}this._firstFreeElement=e}},i}(V),z=function(t){function i(t){this._ready=!1,this.textureList=[],this.particleList=[],this.pX=0,this.pY=0,this.activeParticles=[],this.deadParticles=[],this.iList=[],this._maxNumParticles=0,this.textureWidth=NaN,this.dTextureWidth=NaN,this.colorChange=!0,this.step=1/60,this.canvasShader=new A,i.__super.call(this),this.settings=t,this._maxNumParticles=t.maxPartices,this.texture=new _,this.texture.on("loaded",this,this._textureLoaded),this.texture.load(t.textureName)}r(i,"laya.particle.ParticleTemplateCanvas",t);var e=i.prototype;return e._textureLoaded=function(t){this.setTexture(this.texture),this._ready=!0},e.clear=function(t){void 0===t&&(t=!0),this.deadParticles.length=0,this.activeParticles.length=0,this.textureList.length=0},e.setTexture=function(t){this.texture=t,this.textureWidth=t.width,this.dTextureWidth=1/this.textureWidth,this.pX=.5*-t.width,this.pY=.5*-t.height,this.textureList=i.changeTexture(t,this.textureList),this.particleList.length=0,this.deadParticles.length=0,this.activeParticles.length=0},e._createAParticleData=function(t,i){this.canvasShader.u_EndVelocity=this.settings.endVelocity,this.canvasShader.u_Gravity=this.settings.gravity,this.canvasShader.u_Duration=this.settings.duration;var e;e=R.Create(this.settings,t,i,0),this.canvasShader.a_RadiusRadian=e.radiusRadian,this.canvasShader.a_Position=e.position,this.canvasShader.a_SizeRotation=e.sizeRotation,this.canvasShader.a_Color=e.color,this.canvasShader.a_Velocity=e.velocity,this.canvasShader.a_AgeAddScale=e.durationAddScale,this.canvasShader.oSize=this.textureWidth;var a=new E,r=0,n=this.settings.duration/(1+e.durationAddScale),s=[];for(r=0;n>r;r+=this.step)s.push(this.canvasShader.getData(r));return a.id=this.particleList.length,this.particleList.push(a),a.setCmds(s),a},e.addParticleArray=function(t,i){if(this._ready){var e;this.particleList.length<this._maxNumParticles?(e=this._createAParticleData(t,i),this.iList[e.id]=0,this.activeParticles.push(e)):this.deadParticles.length>0&&(e=this.deadParticles.pop(),this.iList[e.id]=0,this.activeParticles.push(e))}},e.advanceTime=function(t){if(void 0===t&&(t=1),this._ready){var i,e=this.activeParticles,a=this.deadParticles,r=0,n=e.length,s=0,o=this.iList;for(r=n-1;r>-1;r--)i=e[r],s=o[i.id],s>=i.maxIndex?(s=0,e.splice(r,1),a.push(i)):s+=1,o[i.id]=s}},e.render=function(t,i,e){this._ready&&(this.activeParticles.length<1||this.textureList.length<2||this.canvasRender(t,i,e))},e.noColorRender=function(t,i,e){var a,r,n=this.activeParticles,s=0,o=n.length,l=NaN,h=this.pX,c=this.pY,u=2*-h,d=2*-c,_=0,m=(this.textureList,this.iList),f=NaN;for(t.translate(i,e),f=t.ctx.globalAlpha,s=0;o>s;s++)a=n[s],_=m[a.id],r=a.cmds[_],(l=r[1])<=.01||(t.setAlpha(f*l),t.drawTextureWithTransform(this.texture,h,c,u,d,r[2]));t.setAlpha(f),t.translate(-i,-e)},e.canvasRender=function(t,i,e){var a,r,n,s=this.activeParticles,o=0,l=s.length,h=NaN,c=this.pX,u=this.pY,d=2*-c,_=2*-u,m=0,f=this.textureList,p=this.iList,v=NaN;for(t.translate(i,e),v=t.ctx.globalAlpha,n=t.ctx.globalCompositeOperation,t.blendMode("lighter"),o=0;l>o;o++)a=s[o],m=p[a.id],r=a.cmds[m],(h=r[1])<=.01||(t.save(),t.transformByMatrix(r[2]),r[3]>.01&&(t.setAlpha(v*r[3]),t.drawTexture(f[0],c,u,d,_)),r[4]>.01&&(t.setAlpha(v*r[4]),t.drawTexture(f[1],c,u,d,_)),r[5]>.01&&(t.setAlpha(v*r[5]),t.drawTexture(f[2],c,u,d,_)),t.restore());t.setAlpha(v),t.translate(-i,-e),t.blendMode(n)},i.changeTexture=function(t,i){return i||(i=[]),i.length=0,y.copyArray(i,T.getRGBPic(t)),i},i}(V),N=function(t){function i(t){this.x=0,this.y=0,this.blendType=1,this._startTime=0,this.sv=new b,i.__super.call(this,t);var a=this;e.loader.load(this.settings.textureName,o.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,a.texture=t})),this.sv.u_Duration=this.settings.duration,this.sv.u_Gravity=this.settings.gravity,this.sv.u_EndVelocity=this.settings.endVelocity,this.initialize(),this.loadContent()}r(i,"laya.particle.ParticleTemplate2D",t);var a=i.prototype;return e.imps(a,{"laya.webgl.submit.ISubmit":!0}),a.getRenderType=function(){return-111},a.releaseRender=function(){},a.addParticleArray=function(i,e){i[0]+=this.x,i[1]+=this.y,t.prototype.addParticleArray.call(this,i,e)},a.renderSubmit=function(){if(this.texture&&this.texture.loaded){if(this.update(f.DELTA),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement){v.mainContext;this._vertexBuffer.bind(this._indexBuffer),this.sv.u_texture=this.texture.source,this.sv.upload(),this._firstActiveElement<this._firstFreeElement?v.mainContext.drawElements(4,6*(this._firstFreeElement-this._firstActiveElement),5123,6*this._firstActiveElement*2):(v.mainContext.drawElements(4,6*(this.settings.maxPartices-this._firstActiveElement),5123,6*this._firstActiveElement*2),this._firstFreeElement>0&&v.mainContext.drawElements(4,6*this._firstFreeElement,5123,0)),d.drawCall++}this._drawCounter++}return 1},a.blend=function(){if(i.activeBlendType!==this.blendType){var t=v.mainContext;t.enable(3042),p.fns[this.blendType](t),i.activeBlendType=this.blendType}},i.activeBlendType=-1,i}(S),b=function(t){function i(){this.a_CornerTextureCoordinate=[4,5126,!1,92,0],this.a_Position=[3,5126,!1,92,16],this.a_Velocity=[3,5126,!1,92,28],this.a_Color=[4,5126,!1,92,40],this.a_SizeRotation=[3,5126,!1,92,56],this.a_RadiusRadian=[4,5126,!1,92,68],this.a_AgeAddScale=[1,5126,!1,92,84],this.a_Time=[1,5126,!1,92,88],this.u_CurrentTime=NaN,this.u_Duration=NaN,this.u_Gravity=null,this.u_EndVelocity=NaN,this.u_texture=null,i.__super.call(this,0,0)}r(i,"laya.particle.shader.value.ParticleShaderValue",t);var e=i.prototype;return e.upload=function(){this.refresh(),i.pShader.upload(this)},a(i,["pShader",function(){return this.pShader=new L}]),i}(g),F=function(t){function i(t){this._particleTemplate=null,this._canvasTemplate=null,this._emitter=null,i.__super.call(this),l.isWebGL?(this._particleTemplate=new N(t),this.graphics._saveToCmd(l.context._drawParticle,[this._particleTemplate])):(this._particleTemplate=this._canvasTemplate=new z(t),this._renderType|=512),this._emitter=new w(this._particleTemplate)}r(i,"laya.particle.Particle2D",t);var a=i.prototype;return a.play=function(){e.timer.frameLoop(1,this,this._loop)},a.stop=function(){e.timer.clear(this,this._loop)},a._loop=function(){this.advanceTime(1/60)},a.advanceTime=function(t){void 0===t&&(t=1),this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)},a.customRender=function(t,i,e){this._canvasTemplate&&this._canvasTemplate.render(t,i,e)},n(0,a,"emitter",function(){return this._emitter}),i}(c),L=(function(t){function i(){this._particle=null,i.__super.call(this)}r(i,"laya.particle.ParticlePlayer",t);var a=i.prototype;return a.loadParticle=function(t){e.loader.load(t,o.create(this,this.setParticleSetting),null,"json")},a.setParticleSetting=function(t){this._particle&&(this._particle.stop(),this._particle.removeSelf()),this._particle=new F(t),this._particle.emitter.start(),this._particle.play(),this.addChild(this._particle)},n(0,a,"url",null,function(t){this.loadParticle(t)}),i}(c),function(t){function i(){i.__super.call(this,i.vs,i.ps,"ParticleShader")}return r(i,"laya.particle.shader.ParticleShader",t),a(i,["vs",function(){return this.vs="attribute vec4 a_CornerTextureCoordinate;\nattribute vec3 a_Position;\nattribute vec3 a_Velocity;\nattribute vec4 a_Color;\nattribute vec3 a_SizeRotation;\nattribute vec4 a_RadiusRadian;\nattribute float a_AgeAddScale;\nattribute float a_Time;\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\n\nuniform  float u_CurrentTime;\nuniform float u_Duration;\nuniform float u_EndVelocity;\nuniform vec3 u_Gravity;\n\n#ifdef PARTICLE3D\n uniform mat4 u_WorldMat;\n uniform mat4 u_View;\n uniform mat4 u_Projection;\n uniform vec2 u_ViewportScale;\n#else\n uniform vec2 size;\n uniform mat4 mmat;\n#endif\n\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\n{\n\n   float startVelocity = length(velocity);//起始标量速度\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\n\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\n   \n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\n   \n   float radius=mix(a_RadiusRadian.x, a_RadiusRadian.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\n   float radianHorizontal =a_RadiusRadian.z*normalizedAge;\n   float radianVertical =a_RadiusRadian.w*normalizedAge;\n   \n   float r =cos(radianVertical)* radius;\n   addPosition.y += sin(radianVertical) * radius;\n	\n   addPosition.x += cos(radianHorizontal) *r;\n   addPosition.z += sin(radianHorizontal) *r;\n  \n   #ifdef PARTICLE3D\n   position+=addPosition;\n    return  u_Projection*u_View*u_WorldMat*(vec4(position, 1.0));\n   #else\n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\n   position+=addPosition;\n    return vec4(position.xy,0.0,1.0);\n   #endif\n}\n\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\n{    \n    float size = mix(startSize, endSize, normalizedAge);\n    \n	#ifdef PARTICLE3D\n    //Project the size into screen coordinates.\n     return size * u_Projection[1][1];\n	#else\n	 return size;\n	#endif\n}\n\nmat2 ComputeParticleRotation(in float rot,in float age)\n{    \n    float rotation =rot * age;\n    //计算2x2旋转矩阵.\n    float c = cos(rotation);\n    float s = sin(rotation);\n    return mat2(c, -s, s, c);\n}\n\nvec4 ComputeParticleColor(in vec4 color,in float normalizedAge)\n{\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\n   \n    return color;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_Time;\n   age *= 1.0 + a_AgeAddScale;\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\n	\n   #ifdef PARTICLE3D\n	gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize * u_ViewportScale;\n   #else\n	gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize;\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\n   #endif\n   \n   v_Color = ComputeParticleColor(a_Color, normalizedAge);\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\n}\n\n"},"ps",function(){return this.ps="precision highp float;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\n\nvoid main()\n{	\n	gl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n}"}]),i}(s))}(window,document,Laya);